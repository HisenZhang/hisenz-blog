---
import { SITE_BASE } from '@/consts'
import FormattedDate from './FormattedDate.astro'
import type { ImageMetadata } from 'astro'
import { Image } from 'astro:assets'

const { post } = Astro.props

// Fallback to old path structure for existing posts without coverImage
const blogImages = import.meta.glob<{ default: ImageMetadata }>(
	'/src/assets/blogimages/**/*.{jpeg,jpg,png,gif}'
)
const coverImagePath = `/src/assets/blogimages/${post.slug}/cover.jpg`
---

<div class="flex flex-col gap-4 pb-8 h-full group">
	<a href={`${SITE_BASE}/blog/${post.slug}/`}>
		{
			post.data.coverImage ? (
				<Image
					src={post.data.coverImage}
					alt={post.data.title}
					class="object-cover rounded-xl aspect-video"
				/>
			) : blogImages[coverImagePath] && (
				<Image
					src={blogImages[coverImagePath]()}
					alt={post.data.title}
					class="object-cover rounded-xl aspect-video"
				/>
			)
		}
	</a>
	<div class="flex flex-wrap gap-2 items-center">
		{post.data.category && (
			<a
				href={`${SITE_BASE}/blog/category/${post.data.category}`}
				class="text-xs px-2 py-1 bg-primary/10 dark:bg-primary-dark/10 text-primary dark:text-primary-dark rounded-full hover:bg-primary/20 dark:hover:bg-primary-dark/20 transition-colors"
			>
				{post.data.category}
			</a>
		)}
	</div>
	<a href={`${SITE_BASE}/blog/${post.slug}/`}>
		<h4
			class="text-2xl font-semibold group-hover:text-primary dark:group-hover:text-primary-dark group-hover:underline transition-colors"
		>
			{post.data.title}
		</h4>
	</a>
	<p class="line-clamp-3 opacity-80">
		{post.data.description}
	</p>
	{post.data.tags && post.data.tags.length > 0 && (
		<div class="flex flex-wrap gap-2">
			{post.data.tags.map((tag: string) => (
				<a
					href={`${SITE_BASE}/blog/tag/${tag}`}
					class="text-xs opacity-60 hover:opacity-100 hover:underline transition-opacity"
				>
					#{tag}
				</a>
			))}
		</div>
	)}
	<p class="uppercase text-sm mt-auto tracking-tight">
		<FormattedDate date={post.data.pubDate} />
	</p>
</div>
